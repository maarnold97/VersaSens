/*
                              *******************
******************************* C SOURCE FILE *******************************
**                            *******************                          **
**                                                                         **
** project  : VersaSens                                                    **
** filename : versa_tools.c                                                **
** version  : 1                                                            **
** date     : DD/MM/YY                                                     **
**                                                                         **
*****************************************************************************
**                                                                         **
** Copyright (c) EPFL                                                      **
** All rights reserved.                                                    **
**                                                                         **
*****************************************************************************
	 
VERSION HISTORY:
----------------
Version     : 1
Date        : DD/MM/YY
Revised by  : Benjamin Duc
Description : Original version.


*/

/***************************************************************************/
/***************************************************************************/

/**
* @file   versa_tools.c
* @date   DD/MM/YY
* @brief  This is the main header of versa_tools.c
*
* Here typically goes a more extensive explanation of what the header
* defines.
*/

/****************************************************************************/
/**                                                                        **/
/*                             MODULES USED                                 */
/**                                                                        **/
/****************************************************************************/

#include <stdlib.h>
#include "versa_tools.h"
#include <zephyr/logging/log.h>

/****************************************************************************/
/**                                                                        **/
/*                        DEFINITIONS AND MACROS                            */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/*                        TYPEDEFS AND STRUCTURES                           */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/*                      PROTOTYPES OF LOCAL FUNCTIONS                       */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/*                           EXPORTED VARIABLES                             */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/*                            GLOBAL VARIABLES                              */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/*                           EXPORTED FUNCTIONS                             */
/**                                                                        **/
/****************************************************************************/


sensorPacketMetadata init_sensor_packet_metadata(uint8_t sensor_id) {
    sensorPacketMetdata metadata = {0, 0, 0, 0, 0};
    metadata[0] = ((sensor_id & 0x0F)<<4);
    return metadata;
}

void update_sensor_packet_metadata(sensorPacketMetdata* metadata, uint16_t time_s, uint16_t time_ms, uint8_t index, uint8_t length) {
    if(index >= 4 || time_ms >=1000) {
        LOG_ERR("invalid metadata!\n");
        return;
    }

    uint8_t sensor_id = (*metadata)[0];
    (*metadata)[0] = sensor_id | ((index & 0x03)<<2) || (uint8_t)((time_ms & 0x0300)>>8);
    (*metadata)[1] = (uint8_t) (time_ms & 0x00FF);
    (*metadata)[2] = (uint8_t) ((time_s & 0xFF00)>>8);
    (*metadata)[3] = (uint8_t) (time_s & 0x00FF);
    (*metadata)[4] = length;

}



/****************************************************************************/
/**                                                                        **/
/*                            LOCAL FUNCTIONS                               */
/**                                                                        **/
/****************************************************************************/

/****************************************************************************/
/**                                                                        **/
/*                                 EOF                                      */
/**                                                                        **/
/****************************************************************************/